# Instructor Dashboard Database ERD

## Entity Relationship Diagram

This document provides a visual representation of the database schema for the HumanGlue instructor dashboard.

---

## Core Entities Overview

```mermaid
erDiagram
    %% Core User & Organization Entities (from 001_migration)
    users ||--o| instructor_profiles : "has"
    users ||--o| instructor_settings : "has"
    users ||--o{ courses : "creates"
    users ||--o{ workshops : "facilitates"
    organizations ||--o{ courses : "owns"
    organizations ||--o{ workshops : "owns"

    %% Course Hierarchy
    courses ||--o{ course_modules : "contains"
    course_modules ||--o{ course_lessons : "contains"
    courses ||--o{ course_enrollments : "has"
    course_enrollments ||--|| student_progress : "tracks"
    course_enrollments ||--o{ lesson_progress : "has"

    %% Course Co-Teaching
    courses ||--o{ course_instructors : "has"
    users ||--o{ course_instructors : "co-teaches"

    %% Course Reviews & Feedback
    courses ||--o{ course_reviews : "receives"
    users ||--o{ course_reviews : "writes"

    %% Workshops
    workshops ||--o{ workshop_registrations : "has"
    workshops ||--o{ workshop_feedback : "receives"
    workshops ||--o{ workshop_facilitators : "has"
    users ||--o{ workshop_facilitators : "co-facilitates"

    %% Revenue & Activity Tracking
    users ||--o{ revenue_transactions : "earns"
    users ||--o{ student_activity : "instructor"
    users ||--o{ student_activity : "student"
    courses ||--o{ revenue_transactions : "generates"
    workshops ||--o{ revenue_transactions : "generates"

    %% Student Enrollments
    users ||--o{ course_enrollments : "enrolls"
    users ||--o{ workshop_registrations : "registers"
```

---

## Detailed Table Relationships

### Instructor Profile & Settings

```mermaid
erDiagram
    users {
        uuid id PK
        text email
        text full_name
        text role
        uuid organization_id FK
    }

    instructor_profiles {
        uuid id PK
        uuid user_id FK "UNIQUE"
        text bio
        text professional_title
        text[] expertise_tags
        ai_pillar[] pillars
        jsonb education
        jsonb certifications
        int total_students "auto-updated"
        int total_courses "auto-updated"
        decimal average_rating "auto-updated"
        boolean is_verified
    }

    instructor_settings {
        uuid id PK
        uuid user_id FK "UNIQUE"
        jsonb email_notifications
        jsonb push_notifications
        boolean auto_approve_enrollments
        text payment_method
        payout_schedule payout_schedule
    }

    users ||--|| instructor_profiles : "has profile"
    users ||--|| instructor_settings : "has settings"
```

---

### Course Structure & Content

```mermaid
erDiagram
    courses {
        uuid id PK
        uuid instructor_id FK
        uuid organization_id FK "nullable"
        text title
        text slug "UNIQUE"
        course_status status
        ai_pillar pillar
        decimal price_amount
        int enrolled_count "auto-updated"
        int completed_count "auto-updated"
        decimal average_rating "auto-updated"
        decimal total_revenue "auto-updated"
    }

    course_modules {
        uuid id PK
        uuid course_id FK
        text title
        int sort_order
        int duration_minutes
    }

    course_lessons {
        uuid id PK
        uuid module_id FK
        text title
        lesson_type content_type
        text video_url
        jsonb quiz_questions
        int sort_order
        boolean is_preview
    }

    courses ||--o{ course_modules : "contains"
    course_modules ||--o{ course_lessons : "contains"
```

---

### Student Enrollment & Progress

```mermaid
erDiagram
    courses {
        uuid id PK
        text title
    }

    users {
        uuid id PK
        text full_name
    }

    course_enrollments {
        uuid id PK
        uuid user_id FK
        uuid course_id FK
        uuid organization_id FK
        enrollment_status status
        int progress_percentage
        timestamptz last_accessed_at
        timestamptz completed_at
        text certificate_url
    }

    student_progress {
        uuid id PK
        uuid enrollment_id FK "UNIQUE"
        uuid user_id FK
        uuid course_id FK
        int total_lessons
        int completed_lessons
        int progress_percentage "auto-updated"
        int total_watch_time_seconds
        decimal engagement_score
        boolean is_completed
    }

    lesson_progress {
        uuid id PK
        uuid enrollment_id FK
        uuid lesson_id FK
        boolean is_completed
        int time_spent_seconds
        int quiz_score
        timestamptz last_accessed_at
    }

    users ||--o{ course_enrollments : "enrolls in"
    courses ||--o{ course_enrollments : "has"
    course_enrollments ||--|| student_progress : "tracks"
    course_enrollments ||--o{ lesson_progress : "has"
```

---

### Course Reviews & Ratings

```mermaid
erDiagram
    courses {
        uuid id PK
        decimal average_rating "auto-updated"
        int review_count "auto-updated"
    }

    users {
        uuid id PK
    }

    course_enrollments {
        uuid id PK
    }

    course_reviews {
        uuid id PK
        uuid course_id FK
        uuid user_id FK
        uuid enrollment_id FK
        int rating "1-5"
        text title
        text review_text
        int content_quality_rating
        int instructor_rating
        text instructor_response
        timestamptz instructor_responded_at
        boolean is_published
    }

    users ||--o{ course_reviews : "writes"
    courses ||--o{ course_reviews : "receives"
    course_enrollments ||--o{ course_reviews : "verified by"
```

---

### Workshop Structure

```mermaid
erDiagram
    workshops {
        uuid id PK
        uuid instructor_id FK
        uuid organization_id FK "nullable"
        text title
        workshop_type type
        workshop_status status
        timestamptz start_time
        timestamptz end_time
        int capacity_total
        int capacity_remaining
        decimal price_amount
        int enrolled_count "auto-updated"
        int attended_count "auto-updated"
        decimal average_satisfaction "auto-updated"
    }

    workshop_registrations {
        uuid id PK
        uuid workshop_id FK
        uuid user_id FK
        uuid organization_id FK
        registration_status status
        payment_status payment_status
        boolean attended
        int rating
        text feedback
    }

    workshop_feedback {
        uuid id PK
        uuid workshop_id FK
        uuid user_id FK
        uuid registration_id FK
        int overall_satisfaction "1-5"
        int content_rating
        int delivery_rating
        text what_went_well
        text what_could_improve
        int nps_score "0-10"
    }

    users ||--o{ workshops : "facilitates"
    workshops ||--o{ workshop_registrations : "has"
    users ||--o{ workshop_registrations : "registers for"
    workshop_registrations ||--o| workshop_feedback : "provides"
```

---

### Co-Teaching Relationships

```mermaid
erDiagram
    users {
        uuid id PK
        text full_name
    }

    courses {
        uuid id PK
        uuid instructor_id FK "primary instructor"
    }

    workshops {
        uuid id PK
        uuid instructor_id FK "primary facilitator"
    }

    course_instructors {
        uuid course_id PK,FK
        uuid instructor_id PK,FK
        text role "primary|co-instructor|assistant"
        jsonb permissions
    }

    workshop_facilitators {
        uuid workshop_id PK,FK
        uuid facilitator_id PK,FK
        text role "primary|co-facilitator|assistant"
    }

    users ||--o{ courses : "primary instructor"
    users ||--o{ course_instructors : "co-teaches"
    courses ||--o{ course_instructors : "has co-instructors"

    users ||--o{ workshops : "primary facilitator"
    users ||--o{ workshop_facilitators : "co-facilitates"
    workshops ||--o{ workshop_facilitators : "has co-facilitators"
```

---

### Revenue & Transactions

```mermaid
erDiagram
    users {
        uuid id PK
    }

    revenue_transactions {
        uuid id PK
        uuid instructor_id FK
        uuid student_id FK
        transaction_type transaction_type
        decimal amount
        decimal platform_fee_percentage
        decimal platform_fee_amount
        decimal instructor_earnings
        uuid course_id FK "nullable"
        uuid workshop_id FK "nullable"
        payment_status payment_status
        text payout_status
        timestamptz transaction_date
    }

    courses {
        uuid id PK
        decimal total_revenue "auto-updated"
    }

    workshops {
        uuid id PK
        decimal total_revenue "auto-updated"
    }

    users ||--o{ revenue_transactions : "instructor earns"
    users ||--o{ revenue_transactions : "student pays"
    courses ||--o{ revenue_transactions : "generates"
    workshops ||--o{ revenue_transactions : "generates"
```

---

### Student Activity Timeline

```mermaid
erDiagram
    users {
        uuid id PK
    }

    student_activity {
        uuid id PK
        uuid instructor_id FK
        uuid student_id FK
        activity_type activity_type
        text activity_title
        text activity_description
        uuid course_id FK "nullable"
        uuid workshop_id FK "nullable"
        uuid lesson_id FK "nullable"
        jsonb metadata
        timestamptz occurred_at
    }

    courses {
        uuid id PK
    }

    workshops {
        uuid id PK
    }

    users ||--o{ student_activity : "instructor"
    users ||--o{ student_activity : "student"
    courses ||--o{ student_activity : "related to"
    workshops ||--o{ student_activity : "related to"
```

---

## Data Flow Diagrams

### Course Enrollment Flow

```mermaid
flowchart TB
    A[Student enrolls in course] --> B[course_enrollments created]
    B --> C[Trigger: create_student_progress]
    C --> D[student_progress record created]
    B --> E[Trigger: update_course_enrollment_stats]
    E --> F[courses.enrolled_count incremented]
    B --> G[Trigger: log_student_activity]
    G --> H[student_activity record created]
    B --> I{Payment completed?}
    I -->|Yes| J[Trigger: create_revenue_transaction]
    J --> K[revenue_transactions record created]
    J --> L[courses.total_revenue updated]
```

### Lesson Completion Flow

```mermaid
flowchart TB
    A[Student completes lesson] --> B[lesson_progress updated]
    B --> C[Trigger: update_student_progress_from_lesson]
    C --> D[Recalculate completed_lessons]
    C --> E[Recalculate progress_percentage]
    C --> F[Update total_watch_time_seconds]
    E --> G{100% complete?}
    G -->|Yes| H[student_progress.is_completed = true]
    H --> I[course_enrollments.status = 'completed']
    I --> J[Trigger: update_course_enrollment_stats]
    J --> K[courses.completed_count incremented]
    G -->|No| L[Continue tracking]
```

### Review Submission Flow

```mermaid
flowchart TB
    A[Student submits review] --> B[course_reviews created]
    B --> C[Trigger: update_course_rating]
    C --> D[Recalculate courses.average_rating]
    C --> E[Update courses.review_count]
    D --> F[Trigger: update_instructor_stats]
    F --> G[Recalculate instructor_profiles.average_rating]
```

---

## Index Strategy Overview

### Primary Indexes (Foreign Keys)

All foreign key columns are indexed:
- `instructor_profiles.user_id`
- `courses.instructor_id`
- `courses.organization_id`
- `course_enrollments.user_id`
- `course_enrollments.course_id`
- `student_progress.enrollment_id`
- `revenue_transactions.instructor_id`
- etc.

### Composite Indexes (Multi-Column Queries)

For common query patterns:
```sql
-- Student progress by course + recent activity
(course_id, last_activity_at DESC)

-- Revenue by instructor + date range
(instructor_id, transaction_date DESC)

-- Activity timeline by instructor
(instructor_id, occurred_at DESC)
```

### Partial Indexes (Filtered Queries)

For status-based queries:
```sql
-- Only published courses
WHERE status = 'published'

-- Only upcoming workshops
WHERE status = 'published' AND start_time > now()

-- Only active enrollments
WHERE status IN ('enrolled', 'in_progress')
```

### GIN Indexes (Array/JSONB Fields)

For array and JSONB columns:
```sql
-- Search by expertise tags
instructor_profiles.expertise_tags

-- Search by course tags
courses.tags

-- Filter by pillars
instructor_profiles.pillars
```

---

## Multi-Tenant Architecture

### Data Isolation Pattern

```mermaid
flowchart TB
    subgraph Platform
        A[Platform Admin<br/>role='admin']
    end

    subgraph Organization A
        B[Org Admin<br/>org_id=A]
        C[Instructor 1<br/>org_id=A]
        D[Instructor 2<br/>org_id=A]
    end

    subgraph Organization B
        E[Org Admin<br/>org_id=B]
        F[Instructor 3<br/>org_id=B]
    end

    subgraph Standalone
        G[Instructor 4<br/>org_id=NULL]
    end

    A -->|View All| B
    A -->|View All| C
    A -->|View All| D
    A -->|View All| E
    A -->|View All| F
    A -->|View All| G

    B -->|View Org Data| C
    B -->|View Org Data| D

    E -->|View Org Data| F

    C -->|View Own| C
    D -->|View Own| D
    F -->|View Own| F
    G -->|View Own| G

    C -.->|Cannot View| D
    C -.->|Cannot View| F
    C -.->|Cannot View| G
```

### RLS Policy Hierarchy

1. **Platform Admin** (role='admin')
   - Can view/manage ALL data
   - Bypasses organization checks

2. **Organization Admin** (role='org_admin')
   - Can view data where `organization_id = their_org_id`
   - Cannot view standalone instructors

3. **Instructor** (any user with courses/workshops)
   - Can view/manage where `instructor_id = auth.uid()`
   - Can view co-taught courses via `course_instructors` table
   - Organization admin can view their data if `organization_id` matches

4. **Student** (any user)
   - Can view/manage their own enrollments (`user_id = auth.uid()`)
   - Can view published courses/workshops

---

## Performance Considerations

### Query Optimization Tips

**Dashboard Overview** (expensive query):
```sql
-- Use helper function instead of multiple queries
SELECT * FROM get_instructor_dashboard_stats('instructor-id');

-- Function combines multiple aggregates efficiently
```

**Student List** (with sorting/filtering):
```sql
-- Use composite index on (course_id, last_activity_at)
SELECT * FROM student_progress
WHERE course_id = 'xxx'
ORDER BY last_activity_at DESC;
```

**Revenue Analytics** (date range queries):
```sql
-- Use composite index on (instructor_id, transaction_date)
SELECT * FROM revenue_transactions
WHERE instructor_id = 'xxx'
AND transaction_date BETWEEN '2025-01-01' AND '2025-12-31'
ORDER BY transaction_date DESC;
```

### Scalability Strategies

**Partitioning** (for large tables):
```sql
-- Partition student_activity by month
CREATE TABLE student_activity_2025_01 PARTITION OF student_activity
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

**Materialized Views** (for expensive aggregations):
```sql
-- Pre-compute instructor stats (refresh daily)
CREATE MATERIALIZED VIEW instructor_monthly_revenue AS
SELECT
  instructor_id,
  DATE_TRUNC('month', transaction_date) AS month,
  SUM(instructor_earnings) AS total_earnings
FROM revenue_transactions
GROUP BY instructor_id, month;
```

**Connection Pooling** (Supabase):
- Use Supabase connection pooler for API routes
- Limit concurrent connections per instructor

---

## Summary

This ERD shows a comprehensive instructor dashboard schema with:

✅ **9 new tables** for instructor-specific features
✅ **Enhanced existing tables** (courses, workshops)
✅ **10+ triggers** for automatic stat updates
✅ **4 helper functions** for complex queries
✅ **30+ indexes** for query performance
✅ **Comprehensive RLS policies** for data isolation
✅ **Multi-tenant support** (standalone + org-linked)
✅ **Co-teaching support** (course_instructors, workshop_facilitators)
✅ **Revenue tracking** with platform fee calculations
✅ **Activity timeline** for student engagement

The schema is designed for:
- **Performance**: Strategic indexing, denormalized stats
- **Security**: RLS on every table, instructor isolation
- **Scalability**: Partitioning-ready, materialized views
- **Maintainability**: Clear relationships, comprehensive documentation
